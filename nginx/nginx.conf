load_module modules/ngx_http_brotli_static_module.so;
load_module modules/ngx_stream_module.so;

error_log syslog:server=unix:/run/nginx-error-log,nohostname;
# leave stderr open but minimize duplicate logging to it
error_log stderr emerg;

worker_processes auto;
worker_rlimit_nofile 32768;
worker_shutdown_timeout 1d;

events {
    worker_connections 8192;
}

http {
    root /var/empty;

    include mime.types;
    default_type application/octet-stream;

    charset utf-8;
    charset_types text/css text/javascript text/plain text/xml application/atom+xml;

    keepalive_requests 16;
    keepalive_timeout 0;
    server_tokens off;
    msie_padding off;

    client_max_body_size 1k;
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;
    http2_chunk_size 4k;

    reset_timedout_connection on;
    client_body_timeout 15s;
    client_header_timeout 15s;
    send_timeout 30s;

    max_ranges 1;

    resolver [::1];
    resolver_timeout 15s;

    proxy_connect_timeout 5s;
    proxy_read_timeout 15s;
    proxy_send_timeout 15s;

    proxy_http_version 1.1;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_429;

    proxy_ssl_protocols TLSv1.3;
    proxy_ssl_server_name on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    proxy_ssl_verify on;
    proxy_ssl_verify_depth 4;

    proxy_cache_path /var/cache/nginx/broadcom.psds.grapheneos.org use_temp_path=off keys_zone=broadcom.psds.grapheneos.org:1m inactive=1h max_size=10m;
    proxy_cache_path /var/cache/nginx/samsung.psds.grapheneos.org use_temp_path=off keys_zone=samsung.psds.grapheneos.org:1m inactive=1h max_size=10m;
    proxy_cache_path /var/cache/nginx/qualcomm.psds.grapheneos.org use_temp_path=off keys_zone=qualcomm.psds.grapheneos.org:1m inactive=1h max_size=10m;
    proxy_cache_path /var/cache/nginx/dl.vanadium.app use_temp_path=off keys_zone=dl.vanadium.app:1m inactive=1h max_size=2G;

    http2_max_concurrent_streams 16;
    limit_conn_status 429;
    limit_conn_zone $binary_remote_addr zone=http-limit:10m;
    limit_conn http-limit 128;
    limit_req_status 429;
    limit_req_zone $binary_remote_addr zone=nominatim-limit:10m rate=12r/m;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers on;
    ssl_conf_command Options PrioritizeChaCha;

    ssl_certificate /etc/letsencrypt/live/grapheneos.network/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/grapheneos.network/privkey.pem;

    # managed externally in noswap tmpfs
    ssl_session_ticket_key /etc/tls/session-ticket-keys/4.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/3.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/2.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/1.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/next.key;
    ssl_session_timeout 1d;
    ssl_buffer_size 4k;

    log_format main '$connection-$connection_requests $remote_addr $remote_user $ssl_session_reused $ssl_protocol $server_protocol '
        '$host $request_method "$request_uri" $status $request_length $body_bytes_sent/$bytes_sent '
        '$request_time $upstream_connect_time/$upstream_header_time/$upstream_response_time '
        '$upstream_cache_status "$http_referer" "$http_user_agent"';
    log_format noquery '$connection-$connection_requests $remote_addr $remote_user $ssl_session_reused $ssl_protocol $server_protocol '
        '$host $request_method "$request_uri_no_query" $status $request_length $body_bytes_sent/$bytes_sent '
        '$request_time $upstream_connect_time/$upstream_header_time/$upstream_response_time '
        '$upstream_cache_status "$http_referer" "$http_user_agent"';
    access_log syslog:server=unix:/run/nginx-access-log,nohostname main;
    log_subrequest on;
    log_not_found off;

    gzip_proxied any;
    gzip_vary on;

    if_modified_since before;

    aio threads;
    aio_write on;

    map $uri $preload_resources_uri {
        /articles/grapheneos-servers.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /build.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /faq.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /features.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /index.html ", <[[path|/pixel-7-pro.svg]]>; rel=preload; as=image; fetchpriority=high, <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /install/cli.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /install/index.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /install/web.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /releases.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
        /usage.html ", <[[path|/js/redirect.js]]>; rel=modulepreload; integrity=[[integrity|/js/redirect.js]]";
    }

    map $request_uri $request_uri_no_query {
        "~^([^?]*\??)" $1;
    }

    map $msec $msec_integer {
        ~(\d+)\.(\d+) $1$2;
    }

    map $uri $vanadium_cache_uri {
        ~/(dl|edgedl)/(.+) /$2;
        default $uri;
    }

    upstream remoteprovisioning.googleapis.com {
        zone remoteprovisioning.googleapis.com 128k;
        server remoteprovisioning.googleapis.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream www.googleapis.com {
        zone www.googleapis.com 128k;
        server www.googleapis.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream gllto.glpals.com {
        zone gllto.glpals.com 128k;
        server gllto.glpals.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream 1.ssiloc.com {
        zone 1.ssiloc.com 128k;
        server 1.ssiloc.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream path1.xtracloud.net {
        zone path1.xtracloud.net 128k;
        server path1.xtracloud.net:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream dl.google.com {
        zone dl.google.com 128k;
        server dl.google.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream www.google.com {
        zone www.google.com 128k;
        server www.google.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream edgedl.me.gvt1.com {
        zone edgedl.me.gvt1.com 128k;
        server edgedl.me.gvt1.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream update.googleapis.com {
        zone update.googleapis.com 128k;
        server update.googleapis.com:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream nominatim.openstreetmap.org {
        zone nominatim.openstreetmap.org 128k;
        server europe-01.nominatim.openstreetmap.org:443 max_conns=1024 max_fails=0 resolve;
        server europe-02.nominatim.openstreetmap.org:443 max_conns=1024 max_fails=0 resolve;
        server europe-03.nominatim.openstreetmap.org:443 max_conns=1024 max_fails=0 resolve;
        server stormfly-04.nominatim.openstreetmap.org:443 max_conns=1024 max_fails=0 resolve;
    }

    upstream gs-loc.apple.com {
        zone gs-loc.apple.com 128k;
        server gs-loc.apple.com:443 max_conns=1024 max_fails=0 resolve;
    }

    # use glob to conditionally include releases.conf if it exists
    include releases[.]conf;

    server {
        listen 80 default_server backlog=4096 fastopen=16 rcvbuf=2048 sndbuf=2048;
        listen [::]:80 default_server backlog=4096 fastopen=16 rcvbuf=2048 sndbuf=2048;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 421;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name grapheneos.network connectivitycheck.grapheneos.network grapheneos.online connectivitycheck.grapheneos.online;

        location = /generate_204 {
            add_header X-Robots-Tag "none" always;
            return 204;
        }

        location = /gen_204 {
            add_header X-Robots-Tag "none" always;
            return 204;
        }

        location /.well-known/acme-challenge/ {
            return 301 http://mia.grapheneos.org$request_uri;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name grapheneos.org www.grapheneos.org grapheneos.app www.grapheneos.app grapheneos.ca www.grapheneos.ca grapheneos.com www.grapheneos.com grapheneos.dev www.grapheneos.dev grapheneos.foundation www.grapheneos.foundation grapheneos.info www.grapheneos.info grapheneos.net www.grapheneos.net grapheneos.ovh www.grapheneos.ovh grapheneos.page www.grapheneos.page vanadium.app www.vanadium.app www.grapheneos.network www.grapheneos.online time.grapheneos.org broadcom.psds.grapheneos.org samsung.psds.grapheneos.org qualcomm.psds.grapheneos.org remoteprovisioning.grapheneos.org widevineprovisioning.grapheneos.org supl.grapheneos.org nominatim.grapheneos.org gs-loc.apple.grapheneos.org dl.vanadium.app update.vanadium.app;

        location /.well-known/acme-challenge/ {
            return 301 http://mia.grapheneos.org$request_uri;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name mia.grapheneos.org;

        location /.well-known/acme-challenge/ {
            root /srv/certbot;
        }

        location / {
            return 301 https://grapheneos.org$request_uri;
        }
    }

    server {
        listen 443 default_server ssl backlog=4096 fastopen=16;
        listen [::]:443 default_server ssl backlog=4096 fastopen=16;
        http2 on;
        ssl_reject_handshake on;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 421;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name grapheneos.network connectivitycheck.grapheneos.network grapheneos.online connectivitycheck.grapheneos.online;

        location = /generate_204 {
            add_header X-Robots-Tag "none" always;
            return 204;
        }

        location = /gen_204 {
            add_header X-Robots-Tag "none" always;
            return 204;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name time.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        location = / {
            # work around regression in early port to Android 14 not using /generate_204

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_requests 2;
            keepalive_timeout 15s;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Time $msec_integer;

            if ($http_user_agent ~ "Dalvik/2.1.0") {
                return 204;
            }

            return 301 https://grapheneos.org/faq#default-connections;
        }

        location = /generate_204 {
            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_requests 2;
            keepalive_timeout 15s;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
            add_header X-Time $msec_integer;

            return 204;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name remoteprovisioning.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        # before Android 14 QPR2: '/v1:'
        # after Android 14 QPR2: '/v1/:'
        location ~ ^/v1/?: {
            if ($request_method != POST) {
                return 405;
            }
            proxy_pass https://remoteprovisioning.googleapis.com;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            client_max_body_size 16k;
            client_body_buffer_size 16k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

            proxy_hide_header Alt-Svc;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header X-Robots-Tag;

            proxy_max_temp_file_size 8m;

            access_log syslog:server=unix:/run/nginx-access-log,nohostname noquery;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name widevineprovisioning.grapheneos.org;

        # needed to handle long signedRequest
        large_client_header_buffers 4 8k;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        location /certificateprovisioning/v1 {
            if ($request_method != POST) {
                return 405;
            }
            proxy_pass https://www.googleapis.com;

            client_max_body_size 16k;
            client_body_buffer_size 16k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

            proxy_hide_header Alt-Svc;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header X-Robots-Tag;

            proxy_max_temp_file_size 8m;

            access_log syslog:server=unix:/run/nginx-access-log,nohostname noquery;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name broadcom.psds.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        proxy_ignore_headers Set-Cookie X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

        proxy_hide_header Age; # not accurate due to our caching
        proxy_hide_header Alt-Svc;
        proxy_hide_header Content-Type;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header Via;
        proxy_hide_header X-Amz-Cf-Id;
        proxy_hide_header X-Amz-Cf-Pop;
        proxy_hide_header x-amz-server-side-encryption;
        proxy_hide_header X-Cache;
        proxy_hide_header X-Robots-Tag;

        proxy_cache broadcom.psds.grapheneos.org;
        proxy_cache_key $uri; # ignore query string
        proxy_cache_lock on;
        proxy_cache_lock_timeout 60s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_429;
        proxy_cache_background_update on;

        proxy_pass_request_body off;
        proxy_pass_request_headers off;

        proxy_max_temp_file_size 8m;

        open_file_cache max=4 inactive=1h;
        open_file_cache_valid 1h;

        location = /lto2.dat {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://gllto.glpals.com/7day/v5/latest/lto2.dat;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            add_header Content-Type "application/octet-stream";
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = /rto.dat {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://gllto.glpals.com/rto/v1/latest/rto.dat;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            add_header Content-Type "application/octet-stream";
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = /pad/xto/prod/rto/2/rto.dat {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://gllto.glpals.com/rto/v2/latest/rto.dat;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            add_header Content-Type "application/octet-stream";
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = /rtistatus.dat {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://gllto.glpals.com/rtistatus4.dat;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            add_header Content-Type "application/octet-stream";
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        # work around overlay issue for Pixel 8a (akita) in the initial Android 16 port
        location = /p4/42F3 {
            return 301 https://samsung.psds.grapheneos.org/p4/42F3;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name samsung.psds.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        proxy_ignore_headers Set-Cookie X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

        proxy_hide_header Age; # not accurate due to our caching
        proxy_hide_header Alt-Svc;
        proxy_hide_header Cache-Control;
        proxy_hide_header Content-Type;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header Via;
        proxy_hide_header X-Robots-Tag;

        proxy_cache samsung.psds.grapheneos.org;
        proxy_cache_key $uri; # ignore query string
        proxy_cache_lock on;
        proxy_cache_lock_timeout 60s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_429;
        proxy_cache_background_update on;

        proxy_pass_request_body off;
        proxy_pass_request_headers off;

        proxy_max_temp_file_size 8m;

        open_file_cache max=1 inactive=1h;
        open_file_cache_valid 1h;

        location = /p4/42F3 {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://1.ssiloc.com/p4/42F3;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            proxy_cache_valid 200 120s;

            add_header Cache-Control "public, max-age=120";
            add_header Content-Type "application/octet-stream";
            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name qualcomm.psds.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        proxy_ignore_headers Set-Cookie X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

        proxy_hide_header Age; # not accurate due to our caching
        proxy_hide_header Alt-Svc;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header Via;
        proxy_hide_header X-Amz-Cf-Id;
        proxy_hide_header X-Amz-Cf-Pop;
        proxy_hide_header x-amz-meta-xtra-di;
        proxy_hide_header x-amz-server-side-encryption;
        proxy_hide_header X-Cache;
        proxy_hide_header X-Robots-Tag;

        proxy_cache qualcomm.psds.grapheneos.org;
        proxy_cache_key $uri; # ignore query string
        proxy_cache_lock on;
        proxy_cache_lock_timeout 60s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_429;
        proxy_cache_background_update on;

        proxy_pass_request_body off;
        proxy_pass_request_headers off;

        proxy_max_temp_file_size 8m;

        open_file_cache max=1 inactive=1h;
        open_file_cache_valid 1h;

        location = /xtra3Mgrbeji.bin {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://path1.xtracloud.net/xtra3Mgrbeji.bin;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name dl.vanadium.app;

        keepalive_timeout 15s;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        proxy_ignore_headers Set-Cookie X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

        proxy_hide_header Age; # not accurate due to our caching
        proxy_hide_header Alt-Svc;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header X-Robots-Tag;

        proxy_cache dl.vanadium.app;
        proxy_cache_key $vanadium_cache_uri$is_args$args;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 60s;
        proxy_cache_revalidate on;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504 http_429;
        proxy_cache_background_update on;

        proxy_pass_request_body off;
        proxy_pass_request_headers off;

        proxy_max_temp_file_size 8m;

        open_file_cache max=256 inactive=1h;
        open_file_cache_valid 1h;

        location ~ ^/(chrome_component|chromewebstore|diffgen-puffin|release2)/ {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://dl.google.com;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location ~ ^/dl/(chrome_component|chromewebstore|diffgen-puffin|release2)/ {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://www.google.com;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location ~ ^/edgedl/(chrome_component|chromewebstore|diffgen-puffin|release2)/ {
            if ($request_method != GET) {
                return 405;
            }
            proxy_pass https://edgedl.me.gvt1.com;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name update.vanadium.app;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        keepalive_timeout 15s;

        location /service/update2 {
            if ($request_method != POST) {
                return 405;
            }
            proxy_pass https://update.googleapis.com;

            client_max_body_size 16k;
            client_body_buffer_size 16k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

            proxy_hide_header Alt-Svc;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header X-Robots-Tag;

            proxy_max_temp_file_size 8m;

            access_log syslog:server=unix:/run/nginx-access-log,nohostname noquery;
        }

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name www.grapheneos.network www.grapheneos.online;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

        location = / {
            return 301 https://grapheneos.org/faq#default-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name supl.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        location = / {
            return 301 https://grapheneos.org/faq#other-connections;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name nominatim.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

        proxy_hide_header Alt-Svc;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header X-Robots-Tag;

        proxy_max_temp_file_size 8m;

        location = /reverse {
            if ($request_method != GET) {
                return 405;
            }
            if ($http_user_agent != "GrapheneOS geocoder 1") {
                return 403;
            }
            proxy_pass https://nominatim.openstreetmap.org;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            client_max_body_size 16k;
            client_body_buffer_size 16k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            limit_req zone=nominatim-limit burst=4;

            access_log syslog:server=unix:/run/nginx-access-log,nohostname noquery;
        }

        location = /search {
            if ($request_method != GET) {
                return 405;
            }
            if ($http_user_agent != "GrapheneOS geocoder 1") {
                return 403;
            }
            proxy_pass https://nominatim.openstreetmap.org;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_timeout 15s;

            client_max_body_size 16k;
            client_body_buffer_size 16k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            limit_req zone=nominatim-limit burst=4;

            access_log syslog:server=unix:/run/nginx-access-log,nohostname noquery;
        }

        location = / {
            return 301 https://grapheneos.org/articles/grapheneos-servers#grapheneos.network;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name gs-loc.apple.grapheneos.org;

        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

        location = /clls/wloc {
            if ($request_method != POST) {
                return 405;
            }
            proxy_pass https://gs-loc.apple.com;

            # note: location block keepalive configuration does not work for HTTP/2
            keepalive_requests 256;
            keepalive_timeout 15s;

            client_max_body_size 1k;
            client_body_buffer_size 1k;

            add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
            add_header X-Robots-Tag "none" always;

            proxy_ignore_headers X-Accel-Redirect X-Accel-Expires X-Accel-Limit-Rate X-Accel-Buffering X-Accel-Charset;

            proxy_hide_header Alt-Svc;
            proxy_hide_header Set-Cookie;
            proxy_hide_header Strict-Transport-Security;
            proxy_hide_header X-RID;
            proxy_hide_header X-Robots-Tag;

            proxy_ssl_protocols TLSv1.2 TLSv1.3;

            proxy_max_temp_file_size 0;
        }

        location = / {
            return 301 https://grapheneos.org/articles/grapheneos-servers#grapheneos.network;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name www.grapheneos.org grapheneos.app www.grapheneos.app grapheneos.ca www.grapheneos.ca grapheneos.com www.grapheneos.com grapheneos.dev www.grapheneos.dev grapheneos.foundation www.grapheneos.foundation grapheneos.info www.grapheneos.info grapheneos.net www.grapheneos.net grapheneos.ovh www.grapheneos.ovh grapheneos.page www.grapheneos.page;

        ssl_certificate /etc/letsencrypt/live/grapheneos.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grapheneos.org/privkey.pem;

        include security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 301 https://grapheneos.org$request_uri;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name www.vanadium.app;

        ssl_certificate /etc/letsencrypt/live/grapheneos.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grapheneos.org/privkey.pem;

        include security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;

        # https://trac.nginx.org/nginx/ticket/2012
        location / {
            return 301 https://vanadium.app$request_uri;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name vanadium.app;

        ssl_certificate /etc/letsencrypt/live/grapheneos.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grapheneos.org/privkey.pem;

        include security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;

        location = / {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=2592000";
            return 301 https://grapheneos.org/features#vanadium;
        }

        location / {
            return 404;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name grapheneos.org;

        ssl_certificate /etc/letsencrypt/live/grapheneos.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grapheneos.org/privkey.pem;

        include root_grapheneos.org.conf;
        error_page 403 =404 /404;
        error_page 404 /404;

        keepalive_requests 256;
        keepalive_timeout 3m;

        open_file_cache max=2048 inactive=1d;
        open_file_cache_valid 1d;

        include security-headers.conf;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        gzip_static on;
        brotli_static on;

        if ($request_uri ~ ^[^?]*//) {
            rewrite ^(.*)$ $1 permanent;
        }

        location = /, {
            return 301 /;
        }

        location = /security.txt {
            return 301 /.well-known/security.txt;
        }

        location = /bitcoin-address.png {
            return 301 /donate-bitcoin.png;
        }

        location = /bitcoin-donation.png {
            return 301 /donate-bitcoin.png;
        }

        location = /monero-donation.png {
            return 301 /donate-monero.png;
        }

        location = /pdfviewer_privacy_policy {
            return 301 /pdfviewer-privacy-policy;
        }

        # mangled backlinks to /install
        location = /installMinimal {
            return 301 /install/;
        }

        # mangled backlink to /faq
        location = /fa {
            return 301 /faq;
        }

        location = /FAQ {
            return 301 /faq;
        }

        # mangled backlinks to /usage#updates
        location = /updates {
            return 301 /usage#updates;
        }

        # AI hallucination
        location = /download {
            return 301 /install/;
        }

        # work around Mastodon to Nostr bridge issue
        location = /donate. {
            return 301 /donate;
        }

        location = /web-install {
            return 301 /install/web;
        }

        location = /install-web {
            return 301 /install/web;
        }

        location = /cli/install {
            return 301 /install/cli;
        }

        location = /web/install {
            return 301 /install/web;
        }

        location = /generate_204 {
            return 301 /faq#default-connections;
        }

        # redirect away from the old SVG favicon location
        location = /mask-icon.svg {
            return 301 /favicon.svg;
        }

        location = "/legal/Micay_ Copperhead_ Statement of Defendant and Counterclaim.pdf" {
            return 301 /history/copperheados;
        }

        location = /discord {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=86400";
            return 301 https://discord.com/invite/grapheneos;
        }

        location = /code-of-conduct {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=86400";
            return 301 https://discuss.grapheneos.org/d/11-grapheneos-code-of-conduct;
        }

        location = /UBL {
            return 301 /faq#bootloader-locking-setup;
        }

        location = /ubl {
            return 301 /faq#bootloader-locking-setup;
        }

        location = /404 {
            internal;
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            include preload.conf;
            try_files $uri.html =404;
        }

        location = /allowed_signers {}
        location = /allowed_signers.sig {}
        location = /allowed_signers.asc {}

        location = /manifest.webmanifest {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=604800";
        }

        location = /favicon.ico {
            if ($http_accept ~ "image/svg\+xml") {
                rewrite ^ /favicon.svg last;
            }
            include security-headers.conf;
            # avoid breaking image hotlinking such as https://github.com/TryGhost/Ghost/issues/12880
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=604800";
        }

        location = /favicon.svg {
            include security-headers.conf;
            # avoid breaking image hotlinking such as https://github.com/TryGhost/Ghost/issues/12880
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=604800";
        }

        location = /bimi.svg {
            include security-headers.conf;
            # allow https://bimigroup.org/bimi-generator/ to hotlink the image
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=604800";
        }

        location = /.well-known/matrix/client {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=172800";
            default_type application/json;
        }

        location = /.well-known/matrix/server {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=172800";
            default_type application/json;
        }

        location = /.well-known/traffic-advice {
            default_type application/trafficadvice+json;
        }

        location = /geofeed.csv {
            default_type geofeed+csv;
        }

        location = /install/web {
            if ($request_uri ~ \?) {
                rewrite ^(.*)$ $1? permanent;
            }
            include security-headers-base.conf;
            add_header Content-Security-Policy "default-src 'none'; child-src 'self'; connect-src 'self' https://releases.grapheneos.org/; font-src 'self'; img-src 'self'; manifest-src 'self'; script-src 'self'; style-src 'self'; webrtc 'block'; form-action 'none'; frame-ancestors 'none'; base-uri 'none'" always;
            add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), bluetooth=(), camera=(), clipboard-read=(), clipboard-write=(), display-capture=(), document-domain=(), encrypted-media=(), fullscreen=(), gamepad=(), geolocation=(), gyroscope=(), hid=(), idle-detection=(), interest-cohort=(), keyboard-map=(), local-fonts=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(self), serial=(), speaker-selection=(), sync-xhr=(), xr-spatial-tracking=()" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, no-cache";
            include preload.conf;
            try_files $uri.html =404;
        }

        location ^~ /fonts/ {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=31536000, immutable";
            gzip_static off;
            brotli_static off;
        }

        location ~ "/$" {
            if ($request_uri ~ \?) {
                rewrite ^(.*)$ $1? permanent;
            }
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, no-cache";
            include preload.conf;
            try_files ${uri}index.html @noslash;
        }

        # redirect /path/ to /path if /path.html exists
        location @noslash {
            rewrite ^(.*)/$ $1;
            if (-f $request_filename.html) {
                rewrite ^(.*) $1 permanent;
            }
            return 404;
        }

        location = /js/fastboot/ffe7e270/vendor/z-worker-pako.js {
            include security-headers-base.conf;
            add_header Content-Security-Policy "default-src 'none'; connect-src 'self' https://releases.grapheneos.org/; font-src 'self'; img-src 'self'; manifest-src 'self'; script-src 'self'; style-src 'self'; webrtc 'block'; form-action 'none'; frame-ancestors 'none'; base-uri 'none'" always;
            add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), bluetooth=(), camera=(), clipboard-read=(), clipboard-write=(), display-capture=(), document-domain=(), encrypted-media=(), fullscreen=(), gamepad=(), geolocation=(), gyroscope=(), hid=(), idle-detection=(), interest-cohort=(), keyboard-map=(), local-fonts=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), serial=(), speaker-selection=(), sync-xhr=(), usb=(), xr-spatial-tracking=()" always;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        location ~ "\.(?:css|js|map|mjs)$" {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        location ~ "\.svg$" {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        location ~ "\.png$" {
            include security-headers.conf;
            # avoid breaking image hotlinking such as https://github.com/TryGhost/Ghost/issues/12880
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=31536000";
            gzip_static off;
            brotli_static off;
        }

        location ~ "\.atom$" {
            include security-headers.conf;
            # Thunderbird uses wrong origin for feeds: https://bugzilla.mozilla.org/show_bug.cgi?id=1698755
            add_header Cross-Origin-Resource-Policy "cross-origin" always;
            add_header Cache-Control "public, max-age=1800";
        }

        location ~ "\.(?:json|txt|xml)$" {
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, max-age=1800";
        }

        location ~ "/index|\.(?:br|gz|html)$" {
            internal;
        }

        location / {
            if ($request_uri ~ \?) {
                rewrite ^(.*)$ $1? permanent;
            }
            include security-headers.conf;
            add_header Cross-Origin-Resource-Policy "same-origin" always;
            add_header Cache-Control "public, no-cache";
            include preload.conf;
            try_files $uri.html $uri/ =404;
        }
    }

    server {
        listen unix:/run/nginx/status.sock;

        access_log off;

        location = / {
            stub_status;
        }

        location / {
            return 404;
        }
    }
}

stream {
    resolver [::1];
    resolver_timeout 15s;

    proxy_connect_timeout 5s;
    proxy_timeout 15s;

    ssl_handshake_timeout 15s;

    proxy_ssl on;
    proxy_ssl_protocols TLSv1.3;
    proxy_ssl_server_name on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    proxy_ssl_verify on;
    proxy_ssl_verify_depth 4;

    # Legacy devices and OS versions only support TLSv1.1
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA@SECLEVEL=0;
    ssl_prefer_server_ciphers on;
    ssl_conf_command Options PrioritizeChaCha;

    ssl_certificate /etc/letsencrypt/live/supl.grapheneos.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/supl.grapheneos.org/privkey.pem;

    # maintained by rotate-session-ticket-keys in noswap tmpfs
    ssl_session_ticket_key /etc/tls/session-ticket-keys/4.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/3.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/2.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/1.key;
    ssl_session_ticket_key /etc/tls/session-ticket-keys/next.key;
    ssl_session_timeout 1d;

    log_format main "$connection $protocol $remote_addr $server_port $ssl_session_reused $ssl_protocol $ssl_cipher $ssl_server_name "
        "$status $bytes_received $bytes_sent $session_time "
        "$upstream_connect_time/$upstream_first_byte_time/$upstream_session_time";
    access_log syslog:server=unix:/run/nginx-access-log,nohostname main;

    upstream supl.google.com {
        zone supl.google.com 128k;
        server supl.google.com:7275 max_conns=1024 max_fails=0 resolve;
    }

    # Qualcomm and Samsung SUPL lack support for SNI
    server {
        listen 7275 default_server ssl backlog=4096 fastopen=16;
        listen [::]:7275 default_server ssl backlog=4096 fastopen=16;

        # Older Qualcomm SUPL devices also lack support for ECDHE
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA@SECLEVEL=0;
        ssl_dhparam ffdhe2048.txt;

        ssl_certificate /etc/letsencrypt/live/classic.supl.grapheneos.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/classic.supl.grapheneos.org/privkey.pem;

        proxy_pass supl.google.com;
    }

    server {
        listen 7275 ssl;
        listen [::]:7275 ssl;
        server_name supl.grapheneos.org;

        proxy_pass supl.google.com;
    }
}
